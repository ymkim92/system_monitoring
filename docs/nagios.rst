nagios
------

모니터링이 무엇이냐고 묻는다면, 뭐라고 답할 수 있을까?
modbus와 syslog, nagios 차원에서의 답은 이런식이 아닐까 한다.

=============       ===================================================================================================================
모니터링 방법       모니터링이란
=============       ===================================================================================================================
modbus              원격시스템의 변화하는 값들을 주기적으로 관찰하여 표시하고, 필요할 경우 서버에서 원격시스템의 설정값을 변경한다.
syslog              원격시스템에서 발생하는 이벤트 메시지를 서버에서 통합관리한다.
nagios              서버에서 원격시스템에게 정의된 내용을 묻거나, 원격시스템에 정의된 이벤트가 발생할 경우 서버로 보고한다. 단순 정보 수집에 그치지 않고 미리 정해진 횟수 만큼 연속적으로 오류가 발생하면, 정해진 관리자들에게 알림 기능을 제공한다.
=============       ===================================================================================================================


..
    새로운 정보를 추가하거나 필요없는 정보를 빼고자 할 때, 
    유연성(flexibility) 차원에서는 아래와 같은 비교가 가능하다.

    =============       =========================
    모니터링 방법       유연성
    =============       =========================
    modbus              O (모니터링 대상을 추가하고 뺄 수 있지만, 변화된 레지스터의 내용을 별도로 유지해야 함. 즉, 모니터링 값의 의미를 설명하는 문서를 요구함) 
    syslog              OO (원하는 로그를 추가하고 필요없는 로그를 빼는 과정이 매우 용이함. 로그 자체에 모니터링 내용이 설명됨)
    nagios              X (모니터링 항목의 추가 및 삭제가 비교적 복잡함)
    =============       =========================

정보의 방향 차원에서는 아래표를 보라.

=============       =========================
모니터링 방법       정보의 방향
=============       =========================
modbus              양방향 (서버 주도: 서버에서 질의를 보내고 원격시스템에서 응답을 받는 형식)
syslog              단방향 (원격시스템에서 서버로 로그 메시지 전달)
nagios              양방향 (원격시스템에서 서버로 정보를 전달할 수도 있고 서버 주도로 정보를 수신하거나 원격시스템을 제어할 수도 있음)
=============       =========================


nagios는 간단한 명령어에서 스케쥴링, 웹 UI 까지 넓은 영역을 포함하고 있어
한마디로 쉽게 설명하기 어렵다.

.. note:: `Icinga <https://www.icinga.org/>`_, `Shinken <www.shinken-monitoring.org/>`_ 등 nagios 와 동일한 또는 비슷한 기능을 하는 소프트웨어 변종들이 존재한다.

nagios 설치
^^^^^^^^^^^

.. note:: 이 절은 http://askubuntu.com/questions/145518/how-do-i-install-nagios 을 참고하여 작성되었다.

ubuntu에서 nagios 설치는 간단하다.
apache는 이미 설치되어 있다는 가정하에 아래 명령을 수행한다.

::

  $ sudo apt-get install -y nagios3

명령 수행 후 몇 몇 입력창을 보게 될 것이다.  
제일 먼저 나오는 창은 메일 전송을 담당하는 postfix 에 대한 설정이다.
postfix는 nagios를 설치하고 웹화면을 구경한 후에 설치 및 설정할 수 
있으므로 이 시점에서 중요한 부분은 아니라고 할 수 있다.
"Postfix Configuration" 이 제목인 첫 창에서 OK를 클릭한 후 아래와 같이
Internet Site를 선택한다. 

.. image:: _static/nagios/install1.png

다음에 나오는 도메인 네임은 보내는 메일 주소에 사용될 @의 뒷 부분을
입력한다.

다음으로는 nagios 웹 화면에 접속할 비밀번호를 입력하는 창이 나온다.
아이디는 nagiosadmin 이며, 이 아이디와 여기서 입력한 비밀번호로
웹화면에 로그인 할 수 있다.

설치를 마친 후 브라우저에서 ``http://localhost/nagios3`` 를 입력하면
로그인 창이 나오고 아이디와 비밀번호를 입력하면 nagios 웹 화면을
볼 수 있다.

Domain name: test.com

nagios core에 대한 간단한 소개
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
nagios의 핵심은 작은 크기의 모니터링 프로그램인 plugin 의 스케쥴링과 
알림(notification)을 위한 프레임워크라고 정의할 수 있다.
plugin은 exit 코드를 반환하여 plugin의 실행결과를 nagios에게
알릴 수 있으며,
exit 코드는 아래와 같은 의미를 갖는다.

+------+----------+
| Code | Meaning  |
+======+==========+
| 0    | Ok       |
+------+----------+
| 1    | Warning  |
+------+----------+
| 2    | Critical |
+------+----------+
| 3    | Unknown  |
+------+----------+

.. note:: ls와 같은 유닉스 명령어도 nagios plugin과 동일한 방식으로 exit code를 반환하며, ``echo $?`` 명령어로 결과를 확인할 수 있다.

.. note:: 이 절은 David Dosephen의 Building a Monitoring Infrastructure with Nagios 를 참고하여 작성되었다.

nagios plugin은 exit code 이외에도 문자열을 반환하여 세부 정보를 관리자에게
알릴 수 있다.
다음은 예제 plugin이며,
echo문에서 문자열을 출력하고 exit문으로 exit code를 반환한다.

.. code-block:: sh

    #!/bin/sh
    OUTPUT='ping -c5 8.8.8.8 | tail -n2'
    if [ $? -gt 0 ]
    then
        echo "CRITICAL!! $OUTPUT"
        exit 2
    else
        echo "OK! $OUTPUT"
        exit 0
    fi



nagios plugin의 역할은 다음 두가지로 나눌 수 있다.

* Host로부터 정보를 가져온다. (예, CPU 로드, index.html)
* Host의 특정 상태나 비교 결과를 exit code로 반환한다. 

이상의 내용에서 알 수 있는 바와 같이 nagios plugin은 독립적인 
명령어의 역할도 수행할 수 있으므로 테스트 목적으로 간단하게
사용해 볼 수 있다.

.. note:: nagios에서는 많은 수의 plugin을 제공하고 있다. https://www.nagios-plugins.org/ 를 참고하라.


email notification
^^^^^^^^^^^^^^^^^^
